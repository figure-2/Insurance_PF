# Fine-Tuning v4 데이터셋 구축 작업 로그

**작성 일시:** 2025-11-25 05:30

## 1. 가설 (Hypothesis)
- **목표:** 기존 v3 모델의 한계를 극복하기 위해 더 정교하고 다양한 유형의 데이터셋(v4)을 구축한다.
- **초기 가정:**
    1. 단순히 긍정적인 QA만으로는 모델이 "모른다"고 대답하거나 거절해야 할 때를 학습하지 못한다. 따라서 `Negative`(거절) 유형이 필수적이다.
    2. 복잡한 보험금 계산이나 특정 조항을 묻는 질문에 약하므로 `Calculation`(계산) 및 `Article`(조항) 유형을 강화해야 한다.
    3. 사용자는 약관에 있는 단어 그대로 질문하지 않는다. `Synonym`(동의어) 유형을 통해 다양한 표현에 대응력을 높여야 한다.
- **예상 결과:** 5가지 유형(Negative, Positive, Calculation, Article, Synonym)이 균형 잡힌 데이터셋을 통해 모델의 전반적인 응답 품질과 강건성(Robustness)이 향상될 것이다.

## 2. 실험 설계 (Experiment Design)
- **데이터셋 구축 전략:**
    - **소스 데이터:** `/01_Preprocessing/chunked_data.jsonl` (전처리된 보험 약관 청크)
    - **생성 모델:** Google Gemini 2.0 Flash (속도 및 비용 효율성 고려)
    - **목표 수량:** 총 3,800개
        - Positive: 1,900개 (50%) - 기본 지식
        - Negative: 760개 (20%) - 거절 능력
        - Calculation: 570개 (15%) - 수리 추론
        - Article: 380개 (10%) - 근거 인용
        - Synonym: 190개 (5%) - 어휘 확장

- **생성 프로세스:**
    1. **Chunk Classification:** 각 청크를 키워드 기반으로 유형 분류.
    2. **Prompt Engineering:** 각 유형별(Negative, Calculation 등) 전용 프롬프트 사용하여 Gemini API 호출.
    3. **Synonym Expansion:** 초기 5개 키워드 → 35개 키워드로 동의어 사전 확장하여 매칭률 증대.

## 3. 검증 결과 (Validation)

### 3.1 데이터 생성 결과 (Quantitative)
| 유형 | 목표 | 생성됨 | 달성률 | 비고 |
|---|---|---|---|---|
| **Negative** | 760 | 755 | 99.3% | 목표 근접 |
| **Positive** | 1,900 | 2,419 | 127.3% | 초과 달성 |
| **Calculation** | 570 | 537 | 94.2% | 목표 근접 |
| **Article** | 380 | 368 | 96.8% | 목표 근접 |
| **Synonym** | 190 | 184 | 96.8% | **개선 완료** (초기 21개 → 184개) |
| **총계** | **3,800** | **4,263** | **112.2%** | **성공** |

### 3.2 문제 해결 (Problem Solving) - Synonym 유형 부족 현상
- **문제:** 초기 생성 시 Synonym 유형이 21개(11%)에 불과.
- **원인:** 동의어 사전이 5개 키워드(`노트북`, `아내` 등)로 너무 제한적이어서 청크 매칭 실패 시 일반 Positive 유형으로 생성됨.
- **해결:**
    - 동의어 사전을 35개(`자동차`, `사고`, `보험금`, `해지` 등)로 대폭 확장.
    - 청크 매칭률 3.83% → 96.27%로 개선.
- **결과:** 재실행 후 184개 생성 완료 (목표 대비 96.8%).

### 3.3 데이터 품질 검증 결과
- **검증 스크립트:** `validate_and_merge_v4.py`
- **검증 결과:**
    - 원본 데이터: 4,263개
    - 검증 완료 데이터: 4,108개
    - 제거된 데이터: 155개 (중복)
    - 필드 누락: 0개
    - 내용 부실: 0개
- **결론:** 데이터 품질이 양호하며, 중복 데이터만 제거하여 최종 4,108개 확보.

### 3.4 계층적 데이터 분할 결과
- **분할 스크립트:** `split_dataset_v4.py`
- **분할 방식:** Stratified Split (각 유형별 8:2 비율 유지)
- **분할 결과:**

| 유형 | Train | Test | 합계 | 비율 |
|---|---|---|---|---|
| **Negative** | 587개 | 147개 | 734개 | 80.0% / 20.0% |
| **Positive** | 1,833개 | 459개 | 2,292개 | 80.0% / 20.0% |
| **Calculation** | 428개 | 108개 | 536개 | 79.9% / 20.1% |
| **Article** | 289개 | 73개 | 362개 | 79.8% / 20.2% |
| **Synonym** | 147개 | 37개 | 184개 | 79.9% / 20.1% |
| **총계** | **3,284개** | **824개** | **4,108개** | **80.0% / 20.0%** |

- **결과물:**
    - `train_v4.json`: 3,284개 (학습용)
    - `test_v4.json`: 824개 (평가용)

### 3.5 정성 평가 (Qualitative)
- **Negative:** "약관 제23조에 따라 보상받을 수 없습니다"와 같이 근거를 명시하며 거절하는 답변 생성 확인.
- **Calculation:** "지급보험금 = 손해액 - 공제액" 공식을 사용하여 구체적인 금액을 산출하는 과정 포함 확인.
- **Synonym:** "노트북" 대신 "휴대용 컴퓨터"로 질문해도 "노트북"에 대한 약관 내용을 답변하는 등 동의어 처리 능력 확인.

## 4. 의사결정 (Conclusion & Pivot)
- **결론:** v4 데이터셋 구축 및 품질 검증 완료.
- **Pivot:** 초기 계획보다 Positive 데이터가 많이 생성되었으나, 데이터 다양성을 위해 유지하기로 결정. Synonym 부족 문제는 사전 확장으로 해결함.
- **Next Step:**
    1. ✅ `validate_and_merge_v4.py`: 데이터 무결성 검증 완료 (중복 155개 제거).
    2. ✅ `split_dataset_v4.py`: Stratified Split (8:2) 완료.
    3. **다음 단계:** Fine-Tuning v4 학습 시작.

## 5. 최종 데이터셋 현황
- **검증 완료 데이터:** 4,108개 (`train_dataset_v4_clean.json`)
- **학습용 데이터:** 3,284개 (`train_v4.json`)
- **평가용 데이터:** 824개 (`test_v4.json`)
- **데이터 품질:** 중복 제거 완료, 필수 필드 모두 존재, Stratified Split 정확도 80.0% / 20.0% 유지

# Fine-Tuning v4 데이터셋 구축 작업 로그

**작성 일시:** 2025-11-25 05:30

## 1. 가설 (Hypothesis)
- **목표:** 기존 v3 모델의 한계를 극복하기 위해 더 정교하고 다양한 유형의 데이터셋(v4)을 구축한다.
- **초기 가정:**
    1. 단순히 긍정적인 QA만으로는 모델이 "모른다"고 대답하거나 거절해야 할 때를 학습하지 못한다. 따라서 `Negative`(거절) 유형이 필수적이다.
    2. 복잡한 보험금 계산이나 특정 조항을 묻는 질문에 약하므로 `Calculation`(계산) 및 `Article`(조항) 유형을 강화해야 한다.
    3. 사용자는 약관에 있는 단어 그대로 질문하지 않는다. `Synonym`(동의어) 유형을 통해 다양한 표현에 대응력을 높여야 한다.
- **예상 결과:** 5가지 유형(Negative, Positive, Calculation, Article, Synonym)이 균형 잡힌 데이터셋을 통해 모델의 전반적인 응답 품질과 강건성(Robustness)이 향상될 것이다.

## 2. 실험 설계 (Experiment Design)
- **데이터셋 구축 전략:**
    - **소스 데이터:** `/01_Preprocessing/chunked_data.jsonl` (전처리된 보험 약관 청크)
    - **생성 모델:** Google Gemini 2.0 Flash (속도 및 비용 효율성 고려)
    - **목표 수량:** 총 3,800개
        - Positive: 1,900개 (50%) - 기본 지식
        - Negative: 760개 (20%) - 거절 능력
        - Calculation: 570개 (15%) - 수리 추론
        - Article: 380개 (10%) - 근거 인용
        - Synonym: 190개 (5%) - 어휘 확장

- **생성 프로세스:**
    1. **Chunk Classification:** 각 청크를 키워드 기반으로 유형 분류.
    2. **Prompt Engineering:** 각 유형별(Negative, Calculation 등) 전용 프롬프트 사용하여 Gemini API 호출.
    3. **Synonym Expansion:** 초기 5개 키워드 → 35개 키워드로 동의어 사전 확장하여 매칭률 증대.

## 3. 검증 결과 (Validation)

### 3.1 데이터 생성 결과 (Quantitative)
| 유형 | 목표 | 생성됨 | 달성률 | 비고 |
|---|---|---|---|---|
| **Negative** | 760 | 755 | 99.3% | 목표 근접 |
| **Positive** | 1,900 | 2,419 | 127.3% | 초과 달성 |
| **Calculation** | 570 | 537 | 94.2% | 목표 근접 |
| **Article** | 380 | 368 | 96.8% | 목표 근접 |
| **Synonym** | 190 | 184 | 96.8% | **개선 완료** (초기 21개 → 184개) |
| **총계** | **3,800** | **4,263** | **112.2%** | **성공** |

### 3.2 문제 해결 (Problem Solving) - Synonym 유형 부족 현상
- **문제:** 초기 생성 시 Synonym 유형이 21개(11%)에 불과.
- **원인:** 동의어 사전이 5개 키워드(`노트북`, `아내` 등)로 너무 제한적이어서 청크 매칭 실패 시 일반 Positive 유형으로 생성됨.
- **해결:**
    - 동의어 사전을 35개(`자동차`, `사고`, `보험금`, `해지` 등)로 대폭 확장.
    - 청크 매칭률 3.83% → 96.27%로 개선.
- **결과:** 재실행 후 184개 생성 완료 (목표 대비 96.8%).

### 3.3 데이터 품질 검증 (Data Quality Assurance)
- **검증 스크립트:** `validate_and_merge_v4.py`
- **검증 항목 및 결과:**
    1. **JSON 문법:** 오류 없음.
    2. **필수 필드:** `instruction`, `input`, `output`, `type` 모두 존재 (누락 0건).
    3. **중복 제거:** 총 155개 중복 데이터 식별 및 제거.
    4. **품질 필터링:** 내용 부실 데이터 0건.
- **최종 데이터:** 4,108개 (`train_dataset_v4_clean.json`)

### 3.4 계층적 데이터 분할 (Stratified Split)
- **분할 스크립트:** `split_dataset_v4.py`
- **전략:** 각 유형별(Negative, Positive 등) 8:2 비율 유지 (Stratified Sampling).
- **분할 결과:**
    - **Train Set (80%):** 3,284개 (`train_v4.json`)
    - **Test Set (20%):** 824개 (`test_v4.json`)
    - **비율 검증:** 모든 유형에서 정확히 8:2 비율 확인.

### 3.5 정성 평가 (Qualitative Sample Review)
- **Negative:** "약관 제23조에 따라 보상받을 수 없습니다"와 같이 근거를 명시하며 거절하는 답변 생성 확인.
- **Calculation:** "지급보험금 = 손해액 - 공제액" 공식을 사용하여 구체적인 금액을 산출하는 과정 포함 확인.
- **Synonym:** "노트북" 대신 "휴대용 컴퓨터"로 질문해도 "노트북"에 대한 약관 내용을 답변하는 등 동의어 처리 능력 확인.

## 4. 의사결정 (Conclusion & Pivot)
- **결론:** v4 데이터셋 구축 및 품질 검증 완료. 학습을 위한 고품질 데이터(`train_v4.json`)와 공정한 평가를 위한 테스트 데이터(`test_v4.json`) 준비 완료.
- **Pivot:** 초기 계획보다 Positive 데이터가 많이 생성되었으나, 데이터 다양성을 위해 유지하기로 결정. Synonym 부족 문제는 사전 확장으로 해결함. 중복 데이터 155개 제거로 학습 효율성 증대.
- **Next Step:**
    1. **Fine-Tuning 실행:** 준비된 `train_v4.json`을 사용하여 v4 모델 학습 시작.
    2. **평가:** 학습 완료 후 `test_v4.json`을 사용하여 v3 모델과 성능 비교 평가 수행.

